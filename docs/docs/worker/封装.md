---
title: worker_封装
createTime:  2024-3-4
isShowComments: false 
tags:
  - worker
categories:
  - worker
---

## 静态数据

```ts
const eventKey = '__workEvent';
// 自定义方法事件
const infoEvent = {
  stop: `stop${eventKey}`,
};

```

## 操作函数

```ts
// 自定义操作
const customEvent = (infoEvent: any, self: any, data: any) => {
  switch (data._workType) {
    case infoEvent.stop:
      self.close();
      return;
    default:
      return;
  }
};
```

## worker同源函数

```ts
const workFun = () => {
  return (
    infoEvent: any,
    customEvent: any,
    func: IWorkFuncWithProps,
    errorCb: (parameter: any, arg?: any) => ErrorEvent | MessageEvent,
  ) => {
    const selfOnMessage = (func: IWorkFuncWithProps, event: MessageEvent<any>) => {
      const { data } = event;
      // console.log(Object.prototype.toString.call(data) === '[object Object]');
      if (data && Object.prototype.toString.call(data) === '[object Object]' && data._type) {
        self.removeEventListener('message', func.messageFn);
        self.removeEventListener('error', func.errorFn);
        self.removeEventListener('messageerror', func.errorFn);
        customEvent(infoEvent, self, data);
        return;
      }

      func(self, data, event);
    };

    const selfOnError = (
      errorCb: (parameter: any, arg?: any) => ErrorEvent | MessageEvent,
      err: any,
    ) => {
      errorCb(err.message, err);
    };
    func.messageFn = selfOnMessage.bind(self, func);
    func.errorFn = selfOnError.bind(self, errorCb);
    self.addEventListener('message', func.messageFn);
    self.addEventListener('error', func.errorFn);
    self.addEventListener('messageerror', func.errorFn);
  };
};

```

## 定义worker 类

```ts

export class MyWorker {
  func: TWorkFunc;
  worker: Worker | null;
  onMessage: TWorkCb;
  errorCb?: Function;
  constructor(
    func: TWorkFunc,
    cb: TWorkCb,
    options?: WorkerOptions | undefined,
    errorCb?: Function,
  ) {
    this.errorCb = errorCb;
    this.func = func;
    this.worker = null;
    this.onMessage = (event) => {
      cb?.(event.data, event);
    };
    this.start(options);
  }

  start(options: WorkerOptions | undefined) {
    const blob = new Blob(
      [
        `(${workFun().toString()})( ${JSON.stringify(infoEvent)}, ${customEvent}, ${this.func}, ${this.errorCb})`,
      ],
      {
        type: 'text/javascript',
      },
    );
    const url = URL.createObjectURL(blob);
    this.worker = new Worker(url, options);
    this.worker.addEventListener('message', this.onMessage);
  }
  // 停止
  stop() {
    this.worker?.postMessage({
      _workType: infoEvent.stop,
    });
    this.worker?.removeEventListener('message', this.onMessage);
    this.worker!.terminate();
  }
}

```

## 使用

```vue
<template>
  <div @click="sendMsg">2222</div>
  <div @click="stop">停止</div>
</template>

<script setup>
import { MyWorker } from '@pkg';
const work = new MyWorker(
  (worker, msg) => {
    worker.postMessage({
      data: '测试2'
    })
  },
  (...data2) => {

  },
);

work.worker.postMessage({
  data: '测试数据',
});

const sendMsg = () => {
  work.worker.postMessage({
  data: '测试数据55555',
});
}

const stop = () => {
  work.stop()
}
</script>

```